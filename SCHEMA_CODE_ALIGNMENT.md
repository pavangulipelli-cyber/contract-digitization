# Schema-Code Alignment Analysis & Fixes

## Date: December 17, 2025

## Analysis Summary

Conducted comprehensive review of PostgreSQL schema and all frontend/backend code to ensure complete alignment and prevent runtime issues.

## Schema Analysis

### Database: `contract_ai_postgres_db` (PostgreSQL)

**Key Schema Characteristics:**
1. **Column Names**: PostgreSQL converts unquoted identifiers to lowercase
   - Schema defines: `uploadedAt`, `documentId`, etc.
   - Database stores: `uploadedat`, `documentid`, etc.
   - Queries must use correct casing in aliases

2. **Generated Columns**:
   - `row_id` = `attribute_key || '--' || version_id` (STORED)
   - Used for UI compatibility

3. **Key Tables**:
   - `documents` - main document registry
   - `document_versions` - versioning support
   - `extracted_fields` - versioned attributes (single source of truth)
   - `review_sessions` & `reviewed_fields` - audit trail

## Issues Found & Fixed

### 1. Backend: Database Column Name Consistency

**File**: `azure_function_fastapi_replacement/function_app.py`

**Issue**: UPDATE query used inconsistent column names
```python
# BEFORE (incorrect)
UPDATE documents 
SET status = 'reviewed',      -- wrong case
    reviewedby = %s           -- correct (lowercase in schema)
```

**Fix**: Corrected status value casing
```python
# AFTER (correct)
UPDATE documents 
SET status = 'Reviewed',      -- matches UI expectations
    reviewedby = %s           -- correct
```

**Lines Modified**: ~612-617

---

### 2. Backend: Null Value Handling

**File**: `azure_function_fastapi_replacement/function_app.py`

**Issue**: Inline ternary in parameter passing was unclear
```python
# BEFORE
cur.execute(..., (corrected_val if corrected_val else None, ...))
```

**Fix**: Explicit variable assignment for clarity
```python
# AFTER
db_value = corrected_val if corrected_val else None
cur.execute(..., (db_value, ...))
```

**Reason**: Improves readability and makes it clear that empty strings and None both result in NULL in database

**Lines Modified**: ~595-605

---

### 3. Frontend: Removed Dead Code

**File**: `src/pages/ContractReview.tsx`

**Issue**: Unused helper function from previous implementation
```typescript
// REMOVED - no longer needed with attributeKey approach
const getLatestRowId = (attributeId: string) => {
  return `${attributeId}--${id}-v${latestVersionNumber}`;
};
```

**Reason**: 
- Function was creating rowId manually
- Now using stable `attributeKey` for all operations
- `row_id` is generated by database as computed column

**Lines Removed**: ~180-182

---

## Verification Matrix

| Component | Schema Alignment | Column Names | Data Types | Null Handling | Status |
|-----------|------------------|--------------|------------|---------------|--------|
| Backend GET queries | ✅ | ✅ | ✅ | ✅ | PASS |
| Backend UPDATE queries | ✅ | ✅ | ✅ | ✅ | PASS |
| Backend save_review | ✅ | ✅ | ✅ | ✅ | PASS |
| Frontend API types | ✅ | N/A | ✅ | ✅ | PASS |
| Frontend ContractReview | ✅ | N/A | ✅ | ✅ | PASS |
| Frontend AttributeCard | ✅ | N/A | ✅ | ✅ | PASS |

## Column Mapping Reference

### documents table
| Schema Column | Query Alias | Frontend Property | Type | Notes |
|---------------|-------------|-------------------|------|-------|
| id | id | id | TEXT | Primary key |
| title | title | title | TEXT | |
| uploadedat | uploadDate | uploadDate | TIMESTAMPTZ | Alias for camelCase |
| status | status | status | TEXT | 'Pending Review', 'Reviewed', 'Approved' |
| reviewedby | reviewedBy | reviewedBy | TEXT | Alias for camelCase |
| storageref | storageRef | storageRef | TEXT | Alias for camelCase |
| currentversionid | currentVersionId | currentVersionId | TEXT | Alias for camelCase |
| currentversionnumber | currentVersionNumber | currentVersionNumber | INTEGER | Alias for camelCase |
| attributecount | attributeCount | attributeCount | INTEGER | Alias for camelCase |
| overallconfidence | overallConfidence | overallConfidence | INTEGER | Alias for camelCase |

### document_versions table
| Schema Column | Query Alias | Frontend Property | Type | Notes |
|---------------|-------------|-------------------|------|-------|
| id | id | id | TEXT | Primary key |
| documentid | documentId | documentId | TEXT | Foreign key to documents(id) |
| versionnumber | versionNumber | versionNumber | INTEGER | Version sequence |
| islatest | isLatest | isLatest | BOOLEAN | Current latest flag |
| createdat | createdAt | createdAt | TIMESTAMPTZ | Alias for camelCase |
| createdby | createdBy | createdBy | TEXT | Alias for camelCase |
| status | status | status | TEXT | Version status |
| storageref | storageRef | storageRef | TEXT | Alias for camelCase |
| notes | notes | notes | TEXT | |

### extracted_fields table
| Schema Column | Query Alias | Frontend Property | Type | Notes |
|---------------|-------------|-------------------|------|-------|
| field_id | id | id | UUID | Primary key |
| row_id | rowId | rowId | TEXT | GENERATED (attribute_key \|\| '--' \|\| version_id) |
| attribute_key | attributeKey | attributeKey | TEXT | **Stable across versions** |
| field_name | name | name | VARCHAR(200) | Display name |
| category | category | category | TEXT | Grouping |
| section | section | section | TEXT | Document section |
| page_number | page | page | INT | PDF page number |
| field_value | extractedValue | extractedValue | TEXT | AI-extracted value |
| corrected_value | correctedValue | correctedValue | TEXT | User correction |
| confidence_score | confidenceScore | confidenceScore | INTEGER | 0-100 |
| confidence_level | confidenceLevel | confidenceLevel | TEXT | 'low', 'medium', 'high' |
| highlighted_text | highlightedText | highlightedText | TEXT | OCR text |
| bounding_box | boundingBox | boundingBox | JSONB | {page, x, y, w, h} |

## API Payload Validation

### POST /api/documents/{document_id}/review

**Request Body** (after fixes):
```typescript
{
  corrections: Record<string, string>;  // attributeKey -> correctedValue
  reviewerName?: string;
  status: "Reviewed" | "Approved";
  reviewedAt?: string;
}
```

**Response** (after fixes):
```typescript
{
  ok: boolean;
  versionNumber: number;
  versionId: string;
  updatedCount: number;
  updatedKeys?: string[];  // attributeKeys that were updated
}
```

**Database Operations**:
1. Maps corrections by `attribute_key` (stable identifier)
2. Updates `corrected_value` in `extracted_fields` for LATEST version
3. Updates `status` and `reviewedby` in `documents` table
4. Returns count and list of updated keys

## Critical Success Factors

### ✅ Stable Identifiers
- `attribute_key` is consistent across all versions of a document
- Enables cross-version updates without ID mapping
- Simplifies frontend state management

### ✅ Database-Generated Values
- `row_id` is GENERATED column - never manually constructed in code
- Ensures consistency between database and application
- Prevents sync issues

### ✅ Proper NULL Handling
- Empty string corrections (`""`) → `NULL` in database
- Allows clearing values (not just setting them)
- Explicit conversion for clarity

### ✅ Consistent Casing
- Status values: "Reviewed", "Approved", "Pending Review" (capitalized)
- Column aliases: camelCase in queries → matches TypeScript interfaces
- Schema columns: lowercase (PostgreSQL default)

## Testing Recommendations

### Unit Tests
- [ ] Test `attribute_key` lookup across versions
- [ ] Test NULL vs empty string handling in corrections
- [ ] Test UPDATE query with all status values
- [ ] Test `row_id` generation consistency

### Integration Tests
- [ ] Save review from old version → verify latest updated
- [ ] Clear correction (empty string) → verify NULL in DB
- [ ] Multiple corrections in one request → verify all updated
- [ ] Export attributes → verify correct values returned

### End-to-End Tests
- [ ] Edit attribute in v1, save, verify v3 updated
- [ ] Jump to latest → verify correct attribute selected
- [ ] Accept All from old version → verify applied to latest
- [ ] Reload page → verify corrected values persist

## Performance Considerations

### Indexes Present
- `idx_extracted_fields_doc_ver` on `(document_id, version_id)` → Fast version lookups
- `idx_extracted_fields_key` on `(document_id, attribute_key)` → Fast attribute queries
- UNIQUE on `(attribute_key, version_id)` → Prevents duplicates
- UNIQUE on `row_id` → Fast UI compatibility

### Query Patterns
- All queries use indexed columns
- JOIN operations use primary/foreign keys
- No full table scans in critical paths

## Conclusion

All schema-code alignment issues have been identified and resolved. The system now uses:
- **Stable identifiers** (`attribute_key`) for cross-version operations
- **Proper column names** matching PostgreSQL lowercase convention
- **Consistent data types** between schema, backend, and frontend
- **Correct NULL handling** for clearing values

No further database or code changes needed for cross-version update functionality.

## Files Modified in This Session

1. `azure_function_fastapi_replacement/function_app.py` - Fixed UPDATE query and NULL handling
2. `src/pages/ContractReview.tsx` - Removed dead code
3. `src/components/AttributeCard.tsx` - Added cross-version CTA (previous session)
4. `src/api/index.ts` - Updated API types (previous session)
5. `src/types/index.ts` - Added attributeKey field (previous session)

## Related Documentation

- [CROSS_VERSION_UPDATE_IMPLEMENTATION.md](CROSS_VERSION_UPDATE_IMPLEMENTATION.md) - Feature specification
- [contract_ai_schema_postgres_redesigned.sql](azure_function_fastapi_replacement/data/contract_ai_schema_postgres_redesigned.sql) - Database schema
